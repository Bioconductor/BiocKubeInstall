o## Step 0: Define important variables

workers <- 6L
lib_path <- "/host/library"
bin_path <- "/host/binaries"
deps_rds <- "pkg_dependencies.rds"

## Step 0.1:  Wait till all the worker pods are up and running
.kube_wait(workers)

## Step. 1 : Create lib_path and bin_path
.create_library_paths(
    library_path = lib_path,
    binary_path = bin_path
)

## Step. 2 : Load deps and installed packages
if (!file.exists(deps_rds)) {
    deps <- .pkg_dependencies()
} else {
    deps <- readRDS(deps_rds)
}

inst <- installed.packages()


## TODO is encode workers through docker image or kubernetes
kube_install(
    workers = workers,
    lib_path = lib_path,
    bin_path = bin_path,
    deps = deps,
    inst = inst
)

## TODO:
## Compare PACKAGES file from what is in Bioconductor which will be the latest and PACKAGES from what is on the bucket location and just build the new ones.

##.libPaths(c(lib_path, .libPaths()))

gcloud_binary_sync(
    secret = "/home/rstudio/key.json",
    bin_path = "/host/binaries",
    bucket = "gs://anvil-rstudio-bioconductor-test/0.99/3.11/src/contrib/"
)
