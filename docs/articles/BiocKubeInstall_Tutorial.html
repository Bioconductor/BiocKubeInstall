<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiocKubeInstall Usage • BiocKubeInstall</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="BiocKubeInstall Usage">
<meta property="og:description" content="BiocKubeInstall">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BiocKubeInstall</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BiocKubeInstall_Tutorial.html">BiocKubeInstall Usage</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>BiocKubeInstall Usage</h1>
                        <h4 data-toc-skip class="author">Nitesh
Turaga</h4>
            <address class="author_afil">
      Dana Farber Cancer Institute<br><div class="hidden name"><code>BiocKubeInstall_Tutorial.Rmd</code></div>

    </address>
</div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>The BiocKubeInstall package is a cloud computing resource meant
      to be used with Kubernetes. The package is used to create binaries
      for R and Bioconductor packages on specific docker images created
      by Bioconductor. It works in concert with k8sredis - the
      Kubernetes application and RedisParam package that parallelizes
      over a Kubernetes cluster. The package requires knowledge of the
      google cloud, kubernetes, and binary package creation. It is an
      internal package to Bioconductor used to make creation and
      maintainence of package binaries easier and faster.</p>
    </div>
    
<div class="section level2">
<h2 id="prerequesites">Prerequesites<a class="anchor" aria-label="anchor" href="#prerequesites"></a>
</h2>
<p>The following steps assume you have a Google cloud account,
kubernetes controller (<code>kubectl</code>) installed, and your Google
account configured, and have the following APIs enabled on the project
at a minimum.</p>
<pre><code>- Kubernetes Engine Admin
- Storage Admin
- Service account Admin</code></pre>
<p>These services cost money, and are to be used at your expense.</p>
</div>
<div class="section level2">
<h2 id="kubernetes-setup">Kubernetes setup<a class="anchor" aria-label="anchor" href="#kubernetes-setup"></a>
</h2>
<p>The ‘BiocKubeInstall’ package uses the <code>k8sredis</code>
kubernetes configuration files to apply the kuberenetes configurations
on to the GKE cluster.</p>
<p>Once you have <code>k8sredis</code> downloaded from <a href="https://github.com/Bioconductor/k8sredis" class="external-link uri">https://github.com/Bioconductor/k8sredis</a>, you can do the
following.</p>
<div class="section level4">
<h4 id="steps">Steps:<a class="anchor" aria-label="anchor" href="#steps"></a>
</h4>
<p>Default settings used in the following commands are based on local
preferences. Please change them according to your needs.</p>
<p><strong>cluster name</strong>: biock8scluster</p>
<p><strong>zone</strong>: us-east1-b</p>
<p><strong>service account name</strong>: bioc-binaries</p>
<p><strong>project ID</strong>: fancy-house-303821</p>
<ol style="list-style-type: decimal">
<li>
<p>Start a kubernetes cluster,</p>
<pre><code> gcloud container clusters create \
     --zone us-east1-b \
     --num-nodes=6 \
     --machine-type=e2-standard-4 biock8scluster</code></pre>
</li>
<li>
<p>Get the cluster credentials on your local machine,</p>
<pre><code> gcloud container clusters get-credentials --zone us-east1-b biock8scluster</code></pre>
</li>
<li>
<p>Create a service account key. The service account key has
‘Storage Admin’ permissions, so it can upload the binaries to a google
bucket.</p>
<pre><code> ## Create service account
 gcloud iam service-accounts create bioc-binaries \
     --display-name "Storage Admin SA" \
     --description "Bioc Binaries storage admin"

 ## List service account
 gcloud iam service-accounts list \
     --filter bioc-binaries@fancy-house-303821.iam.gserviceaccount.com

 ## Download service account key locally
 gcloud iam service-accounts keys create \
     bioc-binaries.json \
     --iam-account bioc-binaries@fancy-house-303821.iam.gserviceaccount.com

 ## Add 'Storage Admin' role to service account.
 gcloud projects add-iam-policy-binding fancy-house-303821 \
     --member \
     "serviceAccount:bioc-binaries@fancy-house-303821.iam.gserviceaccount.com" \
     --role "roles/storage.admin"</code></pre>
</li>
<li>
<p>Start NFS volume which is going to be attached to your k8s
compute nodes. The NFS mount is where the binary packages will be
stored. The location of the NFS volume is under the directory
<code>/host</code> on your compute nodes.</p>
<pre><code> kubectl apply -f k8s/nfs-volume/</code></pre>
</li>
<li>
<p>Create a kubernetes secret from the service account key which was
downloaded in the previous steps <code>bioc-binaries.json</code>.</p>
<p>The service account key is going to be transmitted to the kubernetes
cluster in an encrypted manner. This command below assumes that
<code>bioc-binaries.json</code> is located in the same path where you
are running the <code>kubectl</code> commands.</p>
<pre><code> kubectl create secret generic \
     bioc-binaries-service-account-auth \
     --from-file=service_account_key=bioc-binaries.json</code></pre>
</li>
<li>
<p>Once the key is created, you can now launch the
<code>bioc-redis</code> configuration on your kubernetes cluster.</p>
<pre><code> kubectl apply -f k8s/bioc-redis</code></pre>
</li>
</ol>
</div>
<div class="section level4">
<h4 id="manage-kubernetes-cluster-if-needed">Manage kubernetes cluster (if needed)<a class="anchor" aria-label="anchor" href="#manage-kubernetes-cluster-if-needed"></a>
</h4>
<p>A few commands which help with the management of the kubernetes
cluster are:</p>
<ul>
<li>
<p>Check if all the pods, services, and nodes are working as
expected:</p>
<pre><code>  kubectl get all</code></pre>
</li>
<li>
<p>Describe specific pods or nodes, to check for failures</p>
<pre><code>  kubectl describe pod/manager</code></pre>
</li>
<li>
<p>Log into a specific pod,</p>
<pre><code>  kubectl exec pod/manager --stdin --tty /bin/bash</code></pre>
</li>
</ul>
<p>To delete and destroy your kubernetes cluster safely,</p>
<pre><code>## Stop redis, rstudio services
kubectl delete -f k8s/bioc-redis/

## Delete NFS volume (this is not recommended)
kubectl delete -f k8s/nfs-volume/

## Delete the kubernetes cluster completely losing all data.
gcloud container clusters delete biock8scluster</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="biockubeinstall">BiocKubeInstall<a class="anchor" aria-label="anchor" href="#biockubeinstall"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
</div>
<div class="section level3">
<h3 id="cluster-architecture-and-design">Cluster architecture and design<a class="anchor" aria-label="anchor" href="#cluster-architecture-and-design"></a>
</h3>
<p>The k8s application launches multiple pods on the nodes within the
cluster. The pods are classified into two types, a single “manager” pod
and multiple “worker” pods. The manager pod delegates reponsibility i.e
the jobs are sent to the workers that actually perform the task. The
worker pods are always listening to the manager and waiting for a job.
Each worker performs a single job till it is done.</p>
<p>The manager and the worker pass messages between each other using
“redis”, and the redis work is available inside the package
“RedisParam”.</p>
<p>Storage is also built into the k8s application. The manager and the
worker also share a volume mount on the k8s cluster in the form of an
NFS volume. The volume is mounted on the path <code>/host/</code>.</p>
<p>The “jobs” here refer to the building of binary R/Bioconductor
packages. Each pod gets a single job, where the job is to build a single
package binary.</p>
</div>
<div class="section level3">
<h3 id="run">Run<a class="anchor" aria-label="anchor" href="#run"></a>
</h3>
<p>To run an actual job, there is one relevant function, i.e
<code><a href="../reference/kube_run.html">BiocKubeInstall::kube_run()</a></code>.</p>
<p>The function needs to be used within the
<code>k8sredis/k8s/bioc-redis/manager-pod.yaml</code> file in your
<code>k8sredis</code> k8s application. Within the specification of the
manager-pod.yaml,</p>
<p>The function takes in the following arguments, the
<code>version</code> of Bioconductor, the docker <code>image_name</code>
for which the binaries are being built and the number of workers which
need to run in parallel as <code>worker_pool_size</code>.</p>
<pre><code>args: ["-e", "BiocKubeInstall::kube_run(version = '3.13',
                    image_name = 'bioconductor_docker',
                    worker_pool_size = 17)"]</code></pre>
<p>The docker image of the manager node is always going to be
<code>bioconductor/bioc-redis:devel</code></p>
</div>
<div class="section level3">
<h3 id="usage-of-binaries-on-bioconductor_docker-images">Usage of Binaries on <code>bioconductor_docker</code> images<a class="anchor" aria-label="anchor" href="#usage-of-binaries-on-bioconductor_docker-images"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">'BiocParallel'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="usage-of-binaries-on-the-anvil">Usage of Binaries on the AnVIL<a class="anchor" aria-label="anchor" href="#usage-of-binaries-on-the-anvil"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">'AnVIL'</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AnVIL</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin17.0 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Big Sur ... 10.16</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib</span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] BiocStyle_2.25.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] rstudioapi_0.13     knitr_1.39          magrittr_2.0.3     </span></span>
<span><span class="co">##  [4] R6_2.5.1            ragg_1.2.2          rlang_1.0.4        </span></span>
<span><span class="co">##  [7] fastmap_1.1.0       stringr_1.4.0       tools_4.2.1        </span></span>
<span><span class="co">## [10] xfun_0.32           cli_3.3.0           jquerylib_0.1.4    </span></span>
<span><span class="co">## [13] systemfonts_1.0.4   htmltools_0.5.3     yaml_2.3.5         </span></span>
<span><span class="co">## [16] digest_0.6.29       rprojroot_2.0.3     pkgdown_2.0.6      </span></span>
<span><span class="co">## [19] bookdown_0.28       textshaping_0.3.6   BiocManager_1.30.18</span></span>
<span><span class="co">## [22] purrr_0.3.4         sass_0.4.2          fs_1.5.2           </span></span>
<span><span class="co">## [25] memoise_2.0.1       cachem_1.0.6        evaluate_0.16      </span></span>
<span><span class="co">## [28] rmarkdown_2.15      stringi_1.7.8       compiler_4.2.1     </span></span>
<span><span class="co">## [31] bslib_0.4.0         desc_1.4.1          jsonlite_1.8.0</span></span></code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nitesh Turaga, Martin Morgan, Alex Mahmoud, Jiefei Wang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
