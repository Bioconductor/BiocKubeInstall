<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiocKubeInstall Usage • BiocKubeInstall</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="BiocKubeInstall Usage">
<meta property="og:description" content="BiocKubeInstall">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BiocKubeInstall</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.99.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BiocKubeInstall_Tutorial.html">BiocKubeInstall Usage</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="BiocKubeInstall_Tutorial_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>BiocKubeInstall Usage</h1>
                        <h4 class="author">Nitesh Turaga</h4>
            <address class="author_afil">
      Dana Farber Cancer Institute<br><div class="hidden name"><code>BiocKubeInstall_Tutorial.Rmd</code></div>

    </address>
</div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>The BiocKubeInstall package is a cloud computing resource meant to be used with Kubernetes. The package is used to create binaries for R and Bioconductor packages on specific docker images created by Bioconductor. It works in concert with k8sredis - the Kubernetes application and RedisParam package that parallelizes over a Kubernetes cluster. The package requires knowledge of the google cloud, kubernetes, and binary package creation. It is an internal package to Bioconductor used to make creation and maintainence of package binaries easier and faster.</p>
    </div>
    
<div id="prerequesites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequesites" class="anchor"></a>Prerequesites</h1>
<p>The following steps assume you have a Google cloud account, kubernetes controller (<code>kubectl</code>) installed, and your Google account configured, and have the following APIs enabled on the project at a minimum.</p>
<pre><code>- Kubernetes Engine Admin
- Storage Admin
- Service account Admin</code></pre>
<p>These services cost money, and are to be used at your expense.</p>
</div>
<div id="kubernetes-setup" class="section level1">
<h1 class="hasAnchor">
<a href="#kubernetes-setup" class="anchor"></a>Kubernetes setup</h1>
<p>The ‘BiocKubeInstall’ package uses the <code>k8sredis</code> kubernetes configuration files to apply the kuberenetes configurations on to the GKE cluster.</p>
<p>Once you have <code>k8sredis</code> downloaded from <a href="https://github.com/Bioconductor/k8sredis" class="uri">https://github.com/Bioconductor/k8sredis</a>, you can do the following.</p>
<div id="steps" class="section level3">
<h3 class="hasAnchor">
<a href="#steps" class="anchor"></a>Steps:</h3>
<p>Default settings used in the following commands are based on local preferences. Please change them according to your needs.</p>
<p><strong>cluster name</strong>: biock8scluster</p>
<p><strong>zone</strong>: us-east1-b</p>
<p><strong>service account name</strong>: bioc-binaries</p>
<p><strong>project ID</strong>: fancy-house-303821</p>
<ol style="list-style-type: decimal">
<li>
<p>Start a kubernetes cluster,</p>
<pre><code> gcloud container clusters create \
     --zone us-east1-b \
     --num-nodes=6 \
     --machine-type=e2-standard-4 biock8scluster</code></pre>
</li>
<li>
<p>Get the cluster credentials on your local machine,</p>
<pre><code> gcloud container clusters get-credentials --zone us-east1-b biock8scluster</code></pre>
</li>
<li>
<p>Create a service account key. The service account key has ‘Storage Admin’ permissions, so it can upload the binaries to a google bucket.</p>
<pre><code> ## Create service account
 gcloud iam service-accounts create bioc-binaries \
     --display-name "Storage Admin SA" \
     --description "Bioc Binaries storage admin"

 ## List service account
 gcloud iam service-accounts list \
     --filter bioc-binaries@fancy-house-303821.iam.gserviceaccount.com

 ## Download service account key locally
 gcloud iam service-accounts keys create \
     bioc-binaries.json \
     --iam-account bioc-binaries@fancy-house-303821.iam.gserviceaccount.com

 ## Add 'Storage Admin' role to service account.
 gcloud projects add-iam-policy-binding fancy-house-303821 \
     --member \
     "serviceAccount:bioc-binaries@fancy-house-303821.iam.gserviceaccount.com" \
     --role "roles/storage.admin"</code></pre>
</li>
<li>
<p>Start NFS volume which is going to be attached to your k8s compute nodes. The NFS mount is where the binary packages will be stored. The location of the NFS volume is under the directory <code>/host</code> on your compute nodes.</p>
<pre><code> kubectl apply -f k8s/nfs-volume/</code></pre>
</li>
<li>
<p>Create a kubernetes secret from the service account key which was downloaded in the previous steps <code>bioc-binaries.json</code>.</p>
<p>The service account key is going to be transmitted to the kubernetes cluster in an encrypted manner. This command below assumes that <code>bioc-binaries.json</code> is located in the same path where you are running the <code>kubectl</code> commands.</p>
<pre><code> kubectl create secret generic \
     bioc-binaries-service-account-auth \
     --from-file=service_account_key=bioc-binaries.json</code></pre>
</li>
<li>
<p>Once the key is created, you can now launch the <code>bioc-redis</code> configuration on your kubernetes cluster.</p>
<pre><code> kubectl apply -f k8s/bioc-redis</code></pre>
</li>
</ol>
</div>
<div id="manage-kubernetes-cluster-if-needed" class="section level3">
<h3 class="hasAnchor">
<a href="#manage-kubernetes-cluster-if-needed" class="anchor"></a>Manage kubernetes cluster (if needed)</h3>
<p>A few commands which help with the management of the kubernetes cluster are:</p>
<ul>
<li>
<p>Check if all the pods, services, and nodes are working as expected:</p>
<pre><code>  kubectl get all</code></pre>
</li>
<li>
<p>Describe specific pods or nodes, to check for failures</p>
<pre><code>  kubectl describe pod/manager</code></pre>
</li>
<li>
<p>Log into a specific pod,</p>
<pre><code>  kubectl exec pod/manager --stdin --tty /bin/bash</code></pre>
</li>
</ul>
<p>To delete and destroy your kubernetes cluster safely,</p>
<pre><code>## Stop redis, rstudio services
kubectl delete -f k8s/bioc-redis/

## Delete NFS volume (this is not recommended)
kubectl delete -f k8s/nfs-volume/

## Delete the kubernetes cluster completely losing all data.
gcloud container clusters delete biock8scluster</code></pre>
</div>
</div>
<div id="biockubeinstall" class="section level1">
<h1 class="hasAnchor">
<a href="#biockubeinstall" class="anchor"></a>BiocKubeInstall</h1>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
</div>
<div id="cluster-architecture-and-design" class="section level2">
<h2 class="hasAnchor">
<a href="#cluster-architecture-and-design" class="anchor"></a>Cluster architecture and design</h2>
<p>The k8s application launches multiple pods on the nodes within the cluster. The pods are classified into two types, a single “manager” pod and multiple “worker” pods. The manager pod delegates reponsibility i.e the jobs are sent to the workers that actually perform the task. The worker pods are always listening to the manager and waiting for a job. Each worker performs a single job till it is done.</p>
<p>The manager and the worker pass messages between each other using “redis”, and the redis work is available inside the package “RedisParam”.</p>
<p>Storage is also built into the k8s application. The manager and the worker also share a volume mount on the k8s cluster in the form of an NFS volume. The volume is mounted on the path <code>/host/</code>.</p>
<p>The “jobs” here refer to the building of binary R/Bioconductor packages. Each pod gets a single job, where the job is to build a single package binary.</p>
</div>
<div id="run" class="section level2">
<h2 class="hasAnchor">
<a href="#run" class="anchor"></a>Run</h2>
<p>To run an actual job, there is one relevant function, i.e <code><a href="../reference/kube_run.html">BiocKubeInstall::kube_run()</a></code>.</p>
<p>The function needs to be used within the <code>k8sredis/k8s/bioc-redis/manager-pod.yaml</code> file in your <code>k8sredis</code> k8s application. Within the specification of the manager-pod.yaml,</p>
<p>The function takes in the following arguments, the <code>version</code> of Bioconductor, the docker <code>image_name</code> for which the binaries are being built and the number of workers which need to run in parallel as <code>worker_pool_size</code>.</p>
<pre><code>args: ["-e", "BiocKubeInstall::kube_run(version = '3.13',
                    image_name = 'bioconductor_docker',
                    worker_pool_size = 17)"]</code></pre>
<p>The docker image of the manager node is always going to be <code>bioconductor/bioc-redis:devel</code></p>
</div>
<div id="usage-of-binaries-on-bioconductor_docker-images" class="section level2">
<h2 class="hasAnchor">
<a href="#usage-of-binaries-on-bioconductor_docker-images" class="anchor"></a>Usage of Binaries on <code>bioconductor_docker</code> images</h2>
<pre><code><a href="https://rdrr.io/pkg/BiocManager/man/install.html">BiocManager::install('Bioconductor/AnVIL')

AnVIL::install('BiocParallel')</a></code></pre>
</div>
<div id="usage-of-binaries-on-the-anvil" class="section level2">
<h2 class="hasAnchor">
<a href="#usage-of-binaries-on-the-anvil" class="anchor"></a>Usage of Binaries on the AnVIL</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AnVIL</span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: dplyr</code></pre>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span><span class="op">(</span><span class="st">'Bioconductor/AnVIL'</span><span class="op">)</span></code></pre></div>
<pre><code>## Bioconductor version 3.13 (BiocManager 1.30.10), R Under development (unstable)
##   (2021-02-05 r79947)</code></pre>
<pre><code>## Installing github package(s) 'Bioconductor/AnVIL'</code></pre>
<pre><code>## Downloading GitHub repo Bioconductor/AnVIL@HEAD</code></pre>
<pre><code>## lifecycle (0.2.0 -&gt; 1.0.0) [CRAN]
## mime      (0.9   -&gt; 0.10 ) [CRAN]
## pillar    (1.4.7 -&gt; 1.5.0) [CRAN]</code></pre>
<pre><code>## Installing 3 packages: lifecycle, mime, pillar</code></pre>
<pre><code>##   
   checking for file ‘/private/var/folders/1w/xf7rrsr1483d4rg7vwbkdy780000gp/T/RtmpQoADLC/remotesf9672d80ba2/Bioconductor-AnVIL-a5f989c/DESCRIPTION’ ...
  
✔  checking for file ‘/private/var/folders/1w/xf7rrsr1483d4rg7vwbkdy780000gp/T/RtmpQoADLC/remotesf9672d80ba2/Bioconductor-AnVIL-a5f989c/DESCRIPTION’
## 
  
─  preparing ‘AnVIL’:
## 
  
   checking DESCRIPTION meta-information ...
  
✔  checking DESCRIPTION meta-information
## 
  
─  checking for LF line-endings in source and make files and shell scripts
## 
  
─  checking for empty or unneeded directories
## 
  
─  building ‘AnVIL_1.3.22.tar.gz’
## 
  
   
## </code></pre>
<pre><code>## Old packages: 'AnVIL', 'boot', 'broom', 'cachem', 'cluster', 'data.table',
##   'DelayedArray', 'deldir', 'edgeR', 'gert', 'lifecycle', 'limma', 'MASS',
##   'MetaboCoreUtils', 'mgcv', 'mime', 'pillar', 'promises', 'ProtGenerics',
##   'ragg', 'RcppArmadillo', 'rmarkdown', 'rstatix', 'scater', 'scuttle',
##   'SingleCellExperiment', 'SparseM', 'spatstat.data', 'systemfonts',
##   'testthat', 'textshaping', 'usethis', 'waldo', 'xfun'</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">AnVIL</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AnVIL/man/localize.html">install</a></span><span class="op">(</span><span class="st">'&lt;package_name&gt;'</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package '&lt;package_name&gt;' is not available for this version of R
## 
## A version of this package for your version of R might be available elsewhere,
## see the ideas at
## https://cran.r-project.org/doc/manuals/r-devel/R-admin.html#Installing-packages</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R Under development (unstable) (2021-02-05 r79947)
## Platform: x86_64-apple-darwin19.6.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS:   /Users/nitesh/R-stuff/bin/R-devel/lib/libRblas.dylib
## LAPACK: /Users/nitesh/R-stuff/bin/R-devel/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] AnVIL_1.3.18     dplyr_1.0.4      BiocStyle_2.19.1
## 
## loaded via a namespace (and not attached):
##  [1] formatR_1.7          compiler_4.1.0       pillar_1.4.7        
##  [4] BiocManager_1.30.10  futile.logger_1.4.3  prettyunits_1.1.1   
##  [7] remotes_2.2.0        futile.options_1.0.1 tools_4.1.0         
## [10] pkgbuild_1.2.0       digest_0.6.27        jsonlite_1.7.2      
## [13] evaluate_0.14        memoise_2.0.0        lifecycle_0.2.0     
## [16] tibble_3.0.6         pkgconfig_2.0.3      rlang_0.4.10        
## [19] cli_2.3.0            DBI_1.1.1            curl_4.3            
## [22] yaml_2.2.1           pkgdown_1.6.1        xfun_0.20           
## [25] fastmap_1.1.0        withr_2.4.1          httr_1.4.2          
## [28] stringr_1.4.0        knitr_1.31           desc_1.2.0          
## [31] generics_0.1.0       fs_1.5.0             vctrs_0.3.6         
## [34] systemfonts_1.0.0    rprojroot_2.0.2      tidyselect_1.1.0    
## [37] glue_1.4.2           R6_2.5.0             textshaping_0.2.1   
## [40] processx_3.4.5       rmarkdown_2.6        bookdown_0.21       
## [43] callr_3.5.1          purrr_0.3.4          lambda.r_1.2.4      
## [46] magrittr_2.0.1       ps_1.5.0             htmltools_0.5.1.1   
## [49] ellipsis_0.3.1       rapiclient_0.1.3     assertthat_0.2.1    
## [52] ragg_0.4.1           stringi_1.5.3        cachem_1.0.3        
## [55] crayon_1.4.1</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nitesh Turaga.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
